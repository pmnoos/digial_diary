<%# filepath: c:\Users\Test\projects\ruby\diary\diary_app\app\views\subscriptions\index.html.erb %>
<div class="container">
  <div class="hero is-light">
    <div class="hero-body">
      <div class="container">
        <h1 class="title">
          <span class="icon-text">
            <span class="icon is-large has-text-primary">
              <i class="fas fa-user-circle"></i>
            </span>
            <span>Your Subscription</span>
          </span>
        </h1>
        <p class="subtitle">
          Manage your Digital Diary subscription and billing
        </p>
      </div>
    </div>
  </div>

  <section class="section">
    <div class="container">
      <% user = @user || current_user %>

      <div class="columns">
        <div class="column is-8">

          <!-- Current Plan -->
          <div class="card mb-5">
            <div class="card-header">
              <p class="card-header-title">
                <span class="icon-text">
                  <span class="icon">
                    <i class="fas fa-credit-card"></i>
                  </span>
                  <span>Current Plan</span>
                </span>
              </p>
            </div>

            <div class="card-content">
              <% if user&.subscription_active? %>
                <div class="level">
                  <div class="level-left">
                    <div class="level-item">
                      <div>
                        <p class="title is-4 has-text-success mb-1">
                          <%= (user.subscription_plan || 'monthly').humanize %> Plan
                        </p>
                        <p class="subtitle is-6 mt-1">
                          Status: <span class="tag is-success">Active</span>
                        </p>
                      </div>
                    </div>
                  </div>
                  <div class="level-right">
                    <div class="level-item">
                      <div class="has-text-right">
                        <p class="title is-4 mb-1">
                          <%= user.subscription_plan == 'yearly' ? '$59.99/year' : '$9.99/month' %>
                        </p>
                        <% if user.subscription_plan == 'yearly' %>
                          <p class="subtitle is-6 mt-1">You're saving $59.89 per year! ðŸŽ‰</p>
                        <% end %>
                      </div>
                    </div>
                  </div>
                </div>

                <!-- Manage subscription actions -->
                <div class="buttons mt-3">
                  <% if user.subscription_plan == 'yearly' %>
                    <%= button_to "Switch to Monthly",
                          change_plan_subscriptions_path(plan: 'monthly'),
                          method: :patch,
                          class: "button is-link is-light",
                          form: { data: { turbo: false } } %>
                  <% else %>
                    <%= button_to "Switch to Yearly",
                          change_plan_subscriptions_path(plan: 'yearly'),
                          method: :patch,
                          class: "button is-link is-light",
                          form: { data: { turbo: false } } %>
                  <% end %>

                  <%= button_to "Cancel Subscription",
                        cancel_subscriptions_path,
                        method: :post,
                        class: "button is-danger is-light",
                        form: { data: { turbo: false } },
                        data: { confirm: "Are you sure you want to cancel? Youâ€™ll keep access until the end of your billing period." } %>
                </div>

                <div class="content">
                  <h5 class="title is-5">âœ¨ You have access to:</h5>
                  <div class="columns">
                    <div class="column">
                      <ul>
                        <li>âœ… Unlimited diary entries</li>
                        <li>âœ… Rich text editing</li>
                        <li>âœ… Photo attachments</li>
                        <li>âœ… Mood tracking</li>
                      </ul>
                    </div>
                    <div class="column">
                      <ul>
                        <li>âœ… Advanced search & filters</li>
                        <li>âœ… Export to PDF/Word</li>
                        <li>âœ… Cloud backup</li>
                        <li>âœ… Priority support</li>
                      </ul>
                    </div>
                  </div>
                </div>

              <% elsif user&.trial_active? %>
                <div class="content">
                  <p class="title is-4 has-text-info">
                    Free Trial Active
                  </p>
                  <p class="subtitle">
                    You have <strong><%= @days_remaining %> days</strong> remaining in your trial
                  </p>

                  <!-- Trial Progress Bar -->
                  <div class="field">
                    <label class="label">Trial Progress</label>
                    <progress class="progress is-info" value="<%= @trial_progress %>" max="100">
                      <%= @trial_progress %>%</progress>
                    <p class="help"><%= @trial_progress %>% of your trial period used</p>
                  </div>

                  <!-- Entry Limit Progress -->
                  <div class="field">
                    <label class="label">Entry Limit</label>
                    <progress class="progress is-warning" value="<%= 50 - @entries_remaining %>" max="50">
                      <%= 50 - @entries_remaining %>/50</progress>
                    <p class="help">
                      You can create <strong><%= @entries_remaining %></strong> more entries in your trial
                    </p>
                  </div>
                </div>

              <% else %>
                <div class="content has-text-centered">
                  <p class="title is-4 has-text-danger">Trial Expired</p>
                  <p class="subtitle">Your free trial has ended. Upgrade to continue using Digital Diary.</p>

                  <!-- Demo Extension for Testing -->
                  <div class="notification is-warning">
                    <h5 class="title is-5">Demo Mode</h5>
                    <p>This is a demo application. Click below to extend your trial for testing purposes.</p>
                    <%= form_with url: demo_mode_subscriptions_path, method: :post, local: true do |form| %>
                      <%= form.hidden_field :extend_trial, value: true %>
                      <%= form.submit "Extend Trial (Demo)", class: "button is-warning" %>
                    <% end %>
                  </div>
                </div>
              <% end %>
            </div>

            <%# Optional footer with trial stats if controller provided them %>
            <% if defined?(@trial_progress) && @trial_progress.present? %>
              <footer class="card-footer">
                <div class="card-footer-item has-text-left" style="flex-direction: column; align-items: flex-start;">
                  <p class="mb-2">Trial progress: <strong><%= @trial_progress %>%</strong></p>
                  <p class="mb-2">Days remaining: <strong><%= @days_remaining %></strong></p>
                  <p>Entries remaining: <strong><%= @entries_remaining %></strong></p>
                </div>
              </footer>
            <% end %>
          </div>

          <!-- Usage Statistics -->
          <div class="card">
            <div class="card-header">
              <p class="card-header-title">
                <span class="icon-text">
                  <span class="icon">
                    <i class="fas fa-chart-bar"></i>
                  </span>
                  <span>Usage Statistics</span>
                </span>
              </p>
            </div>
            <div class="card-content">
              <div class="content">
                <p class="mb-2">Total entries: <strong><%= user.try(:diary_entries)&.count || 0 %></strong></p>
                <p class="mb-2">Images uploaded: <strong><%= user.try(:diary_entries)&.joins(:images_attachments).distinct.count || 0 %></strong></p>
                <p>Most used mood: <strong><%= user.try(:diary_entries)&.group(:mood)&.order(Arel.sql('COUNT(*) DESC'))&.count&.first&.first || 'â€”' %></strong></p>
              </div>
            </div>
          </div>

        </div> <!-- /.column is-8 -->
      </div> <!-- /.columns -->
    </div> <!-- /.container -->
  </section>
</div>