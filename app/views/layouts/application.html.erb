<!DOCTYPE html>
<html>
  <head>
    <title>Digital Diary</title>
    <%= csrf_meta_tags %>
    <%= csp_meta_tag %>
    <!-- Bulma CSS via CDN for proper styling -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.9.4/css/bulma.min.css">
     <!-- FontAwesome Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <%= stylesheet_link_tag "application", "data-turbo-track": "reload" %>
    <%= javascript_importmap_tags %>
    <%= stylesheet_link_tag "actiontext", media: "all", "data-turbo-track": "reload" %>
  </head>
  <body>
    <!-- PWA Install Banner -->
    <div id="pwa-install-banner" class="notification is-info is-light" style="display: none; margin: 0; border-radius: 0;">
      <button class="delete" id="dismiss-install-banner"></button>
      <div class="columns is-vcentered">
        <div class="column">
          <strong>üì± Install Digital Diary</strong>
          <p>Add this app to your home screen for a better experience!</p>
        </div>
        <div class="column is-narrow">
          <button id="install-pwa-button" class="button is-primary">
            <span class="icon"><i class="fas fa-download"></i></span>
            <span>Install</span>
          </button>
        </div>
      </div>
    </div>
    
    <div class="container">
      <nav class="navbar is-dark" role="navigation" aria-label="main navigation">
        <div class="navbar-brand">
          <%= link_to root_path, class: "navbar-item" do %>
            <strong>üìî Digital Diary</strong>
          <% end %>
          
          <!-- Mobile hamburger menu -->
          <a role="button" class="navbar-burger" aria-label="menu" aria-expanded="false" data-target="navbar-menu">
            <span aria-hidden="true"></span>
            <span aria-hidden="true"></span>
            <span aria-hidden="true"></span>
          </a>
        </div>
        
        <div class="navbar-menu" id="navbar-menu">
          <div class="navbar-start">
            <%= link_to "Home", root_path, class: "navbar-item" %>
            <%= link_to "Features", features_path, class: "navbar-item" %>
            <%= link_to "Demo Tour", demo_tour_path, class: "navbar-item" %>
            
            <% if user_signed_in? %>
              <%= link_to "My Entries", diary_entries_path, class: "navbar-item" %>
              <%= link_to "Events", events_path, class: "navbar-item" %>
            <% end %>
          </div>
          
          <div class="navbar-end">
            <% if user_signed_in? %>
              <div class="navbar-item">
                <span class="tag is-light">
                  Hello, <%= current_user.username.presence || current_user.email.split('@').first %>
                </span>
              </div>
              <div class="navbar-item">
                <%= button_to "Log out", destroy_user_session_path, 
                    method: :delete, 
                    class: "button is-light is-small", 
                    data: { turbo: false } %>
              </div>
            <% else %>
              <div class="navbar-item">
                <div class="buttons">
                  <%= link_to "Sign Up", new_user_registration_path, class: "button is-primary is-small" %>
                  <%= link_to "Log in", new_user_session_path, class: "button is-light is-small" %>
                </div>
              </div>
            <% end %>
          </div>
        </div>
      </nav>
      
      <div class="columns m-0">
        <% if user_signed_in? && !((controller_name == 'sessions' && action_name == 'new') || (controller_name == 'registrations' && action_name == 'new') || (controller_name == 'home' && action_name == 'index') || (controller_name == 'pages' && action_name == 'landing')) %>
          <aside class="column is-2 is-narrow has-background-light p-3">
            <p class="menu-label ml-3 is-capitalized is-size-6 has-text-weight-bold has-text-info">Navigation</p>
            <ul class="menu-list">
              <li><%= link_to diary_entries_path do %>üìñ Entries<% end %></li>
              <li><%= link_to new_diary_entry_path do %>üìù New Entry<% end %></li>
              <li><%= link_to events_path do %>üìÖ Events<% end %></li>
              <li><%= link_to new_event_path do %>‚ûï New Event/Appointment<% end %></li>
              <li><%= link_to reminders_path do %>üîî Reminders<% end %></li>
              <li><a href="<%= archive_path %>" class="has-text-dark" id="archive-toggle">üóÑÔ∏è Archive</a></li>
              <li><%= link_to subscriptions_path do %>üíé Subscription<% end %></li>
            </ul>
            
            <!-- Trial/Subscription Status -->
            <% if current_user.trial_active? %>
              <div class="notification is-warning is-small mt-4">
                <p class="is-size-7 has-text-centered"><strong>Trial:</strong> <%= current_user.days_left_in_trial %> days left</p>
                <p class="is-size-7 has-text-centered"><strong>Entries:</strong> <%= current_user.remaining_trial_entries %> remaining</p>
                <%= link_to "Upgrade", pricing_subscriptions_path, class: "button is-warning is-small is-fullwidth mt-2" %>
              </div>
            <% elsif current_user.trial_expired? %>
              <div class="notification is-danger is-small mt-4">
                <p class="is-size-7 has-text-centered has-text-white"><strong>Trial Expired</strong></p>
                <%= link_to "Upgrade Now", pricing_subscriptions_path, class: "button is-light is-small is-fullwidth mt-2" %>
              </div>
            <% elsif current_user.subscription_active? %>
              <div class="notification is-success is-small mt-4">
                <p class="is-size-7 has-text-centered"><strong><%= current_user.subscription_plan.humanize %></strong> Plan Active</p>
              </div>
            <% end %>
          </aside>
          <main class="column p-4">
            <%= yield %>
          </main>
        <% else %>
          <main class="column p-4 is-full">
            <%= yield %>
          </main>
        <% end %>
      </div>
    </div>
    
   <%= render 'layouts/footer' %>

    <!-- Image Modal -->
    <div id="imageModal" class="modal">
      <div class="modal-background" onclick="closeImageModal()"></div>
      <div class="modal-content">
        <div class="box">
          <div class="has-text-centered">
            <img id="modalImage" src="" alt="" style="max-width: 100%; max-height: 80vh; object-fit: contain;">
            <p id="modalImageName" class="mt-3 has-text-grey"></p>
          </div>
        </div>
      </div>
      <button class="modal-close is-large" onclick="closeImageModal()"></button>
    </div>

    <!-- Font Awesome for icons -->
    <script src="https://kit.fontawesome.com/a076d05399.js" crossorigin="anonymous"></script>
    
    <script>
      // Debug script to test if JavaScript is working
      console.log("Application layout loaded");

      // Mobile navbar toggle
      document.addEventListener('DOMContentLoaded', () => {
        // Get all "navbar-burger" elements
        const navbarBurgers = Array.prototype.slice.call(document.querySelectorAll('.navbar-burger'), 0);

        // Check if there are any navbar burgers
        if (navbarBurgers.length > 0) {
          // Add a click event on each of them
          navbarBurgers.forEach(el => {
            el.addEventListener('click', () => {
              // Get the target from the "data-target" attribute
              const target = el.dataset.target;
              const targetElement = document.getElementById(target);

              // Toggle the "is-active" class on both the "navbar-burger" and the "navbar-menu"
              el.classList.toggle('is-active');
              targetElement.classList.toggle('is-active');
            });
          });
        }
      });

      // Image modal functions
      function openImageModal(imageUrl, imageName) {
        document.getElementById('modalImage').src = imageUrl;
        document.getElementById('modalImageName').textContent = imageName;
        document.getElementById('imageModal').classList.add('is-active');
      }

      function closeImageModal() {
        document.getElementById('imageModal').classList.remove('is-active');
      }

      // Close modal with Escape key
      document.addEventListener('keydown', function(event) {
        if (event.key === 'Escape') {
          closeImageModal();
        }
      });
    </script>
  </body>
</html>