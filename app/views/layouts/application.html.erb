<!DOCTYPE html>
<html>
  <head>
    <title>Digital Diary</title>
    <%= csrf_meta_tags %>
    <%= csp_meta_tag %>
  <!-- Bulma CSS via CDN for proper styling -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.9.4/css/bulma.min.css">
  <%= stylesheet_link_tag "application", "data-turbo-track": "reload" %>
    <%= javascript_importmap_tags %>
    <%= stylesheet_link_tag "actiontext", media: "all", "data-turbo-track": "reload" %>
  </head>
  <body>
    <!-- PWA Install Banner -->
    <div id="pwa-install-banner" class="notification is-info is-light" style="display: none; margin: 0; border-radius: 0;">
      <button class="delete" id="dismiss-install-banner"></button>
      <div class="columns is-vcentered">
        <div class="column">
          <strong>ğŸ“± Install Digital Diary</strong>
          <p>Add this app to your home screen for a better experience!</p>
        </div>
        <div class="column is-narrow">
          <button id="install-pwa-button" class="button is-primary">
            <span class="icon"><i class="fas fa-download"></i></span>
            <span>Install</span>
          </button>
        </div>
      </div>
    </div>
    <div class="container">
      <nav class="navbar is-dark" role="navigation" aria-label="main navigation">
        <div class="navbar-brand">
          <a class="navbar-item" href="/">ğŸ“” Digital Diary</a>
        </div>
        <div class="navbar-menu">
          <div class="navbar-end">
            <% if user_signed_in? %>
              <div class="navbar-item">Hello, <%= current_user.username.presence || current_user.email %></div>
              <div class="navbar-item">
                <%= button_to "Log out", destroy_user_session_path, method: :delete, class: "button is-light", data: { turbo: false } %>
              </div>
            <% else %>
              <div class="navbar-item">
                <%= link_to "Demo Tour", "#", onclick: "showDemoTour(); return false;", class: "button is-info" %>
                <%= link_to "Sign Up", new_user_registration_path, class: "button is-primary" %>
                <%= link_to "Log in", new_user_session_path, class: "button is-light" %>
              </div>
            <% end %>
          </div>
        </div>
      </nav>
      <div class="columns m-0">
        <% if user_signed_in? && !((controller_name == 'sessions' && action_name == 'new') || (controller_name == 'registrations' && action_name == 'new') || (controller_name == 'home' && action_name == 'index')) %>
          <aside class="column is-2 is-narrow has-background-light p-3">
            <p class="menu-label ml-3 is-capitalized is-size-6 has-text-weight-bold has-text-info">Navigation</p>
            <ul class="menu-list">
              <li><%= link_to diary_entries_path do %>ğŸ“– Entries<% end %></li>
              <li><%= link_to new_diary_entry_path do %>ğŸ“ New Entry<% end %></li>
              <li><a href="<%= archive_path %>" class="has-text-dark" id="archive-toggle">ğŸ—„ï¸ Archive</a></li>
              <li><%= link_to subscriptions_path do %>ğŸ’ Subscription<% end %></li>
            </ul>
            <% if user_signed_in? && current_user.trial_active? %>
              <div class="notification is-warning is-small mt-4">
                <p class="is-size-7 has-text-centered"><strong>Trial:</strong> <%= current_user.days_left_in_trial %> days left</p>
                <p class="is-size-7 has-text-centered"><strong>Entries:</strong> <%= current_user.remaining_trial_entries %> remaining</p>
                <%= link_to "Upgrade", pricing_subscriptions_path, class: "button is-warning is-small is-fullwidth mt-2" %>
              </div>
            <% elsif user_signed_in? && current_user.trial_expired? %>
              <div class="notification is-danger is-small mt-4">
                <p class="is-size-7 has-text-centered has-text-white"><strong>Trial Expired</strong></p>
                <%= link_to "Upgrade Now", pricing_subscriptions_path, class: "button is-light is-small is-fullwidth mt-2" %>
              </div>
            <% elsif user_signed_in? && current_user.subscription_active? %>
              <div class="notification is-success is-small mt-4">
                <p class="is-size-7 has-text-centered"><strong><%= current_user.subscription_plan.humanize %></strong> Plan Active</p>
              </div>
            <% end %>
          </aside>
          <main class="column p-4">
            <%= yield %>
          </main>
        <% else %>
          <main class="column p-4 is-full">
            <%= yield %>
          </main>
        <% end %>
      </div>
    </div>
    <div class="container">
    <footer class="footer has-background-light mt-3">
      <div class="content has-text-centered">
        <p><strong>Digital Diary</strong><br><span class="is-size-4 has-text-grey">Created By EasyABC-International &copy; <%= Time.current.year %></span></p>
        <p class="mt-1">Made with Ruby on Rails & Bulma.</p>
      </div>
    </footer>
  </div>  
  </body>
  <script>
  // Debug script to test if JavaScript is working
  console.log("Application layout loaded");
  </script>
</html>
