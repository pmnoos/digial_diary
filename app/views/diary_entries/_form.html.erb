<%= form_with(model: @diary_entry, local: true) do |form| %>

  <% if @diary_entry.errors.any? %>
    <div class="notification is-danger">
      <ul>
        <% @diary_entry.errors.full_messages.each do |msg| %>
          <li><%= msg %></li>
        <% end %>
      </ul>
    </div>
  <% end %>

  <div class="field">
    <%= form.label :title, class: "label" %>
    <div class="control">
      <%= form.text_field :title, class: "input" %>
    </div>
  </div>

  <div class="field">
    <%= form.label :entry_date, class: "label" %>
    <div class="control">
      <%= form.date_field :entry_date, class: "input", value: (@diary_entry.entry_date || Date.current) %>
    </div>
    <p class="help has-text-info">Select the date for your diary entry</p>
  </div>

  <div class="field">
    <%= form.label :content, "Diary Entry Content", class: "label" %>
    <div class="control">
      <%= form.rich_text_area :content, class: "rich-text-area", data: { behavior: "content-placeholder" } %>
    </div>
    <p class="help">Write your diary entry here...</p>
  </div>

  <!-- Existing Images Display -->
  <% if @diary_entry.persisted? && @diary_entry.images.attached? %>
    <div class="field">
      <label class="label">Current Photos</label>
      <div class="columns is-multiline is-mobile">
        <% @diary_entry.images.each_with_index do |image, index| %>
          <div class="column is-one-quarter-desktop is-one-third-tablet is-half-mobile">
            <div class="card" style="position: relative;">
              <div class="card-image">
                <figure class="image is-square">
                  <% begin %>
                    <%= image_tag image.variant(:thumb), 
                        alt: "Photo #{index + 1}",
                        style: "width: 100%; height: 150px; object-fit: cover;",
                        loading: "lazy" %>
                  <% rescue => e %>
                    <div style="padding: 1rem; background: #ffebee; text-align: center; height: 150px; display: flex; justify-content: center; align-items: center; flex-direction: column;">
                      <i class="fas fa-exclamation-triangle has-text-danger"></i>
                      <p class="is-size-7 mt-2">Processing error</p>
                    </div>
                  <% end %>
                </figure>
                
                <!-- Delete button for current images -->
                <div style="position: absolute; top: 8px; right: 8px;">
                  <%= link_to remove_image_diary_entry_path(@diary_entry, image_id: image.id), 
                      method: :delete,
                      data: { 
                        turbo_method: :delete,
                        turbo_confirm: "Are you sure you want to delete this image? This action cannot be undone." 
                      },
                      class: "button is-danger is-small is-rounded",
                      style: "opacity: 0.9; box-shadow: 0 2px 4px rgba(0,0,0,0.3);" do %>
                    <span class="icon is-small">
                      <i class="fas fa-trash"></i>
                    </span>
                  <% end %>
                </div>
              </div>
            </div>
          </div>
        <% end %>
      </div>
      <p class="help has-text-info">Current photos attached to this entry. Click the red trash icon to delete individual photos, or upload new photos below to add more.</p>
    </div>
  <% end %>

  <!-- Image Upload Field -->
  <div class="field">
    <%= form.label :images, "Upload Photos", class: "label" %>
    <div class="control">
      <%= form.file_field :images, multiple: true, accept: "image/jpeg,image/jpg,image/png,image/gif,image/webp", 
          class: "file-input", id: "image-upload" %>
      <label for="image-upload" class="file-label">
        <span class="file-cta">
          <span class="file-icon">
            <i class="fas fa-upload"></i>
          </span>
          <span class="file-label">
            Choose photosâ€¦
          </span>
        </span>
      </label>
    </div>
    <p class="help">
      Select one or more photos (JPG, PNG, GIF, WebP) - Max 10MB per image. 
      <strong>Tip:</strong> For best results, use photos under 5MB.
    </p>
    <div id="image-preview" class="mt-3" style="display: none;">
      <p class="has-text-weight-semibold">Selected images:</p>
      <div id="preview-container" class="columns is-multiline"></div>
    </div>
  </div>



  <div class="field">
    <div class="control">
      <%= form.submit class: "button is-primary" %>
    </div>
  </div>
<% end %>

<script>
// Simple date picker enhancement
document.addEventListener('DOMContentLoaded', function() {
  const dateInput = document.getElementById('diary_entry_entry_date');
  if (dateInput && !dateInput.value) {
    // Set today's date as default if no date is set
    const today = new Date().toISOString().split('T')[0];
    dateInput.value = today;
  }

  // Image preview functionality
  const imageUpload = document.getElementById('image-upload');
  const previewDiv = document.getElementById('image-preview');
  const previewContainer = document.getElementById('preview-container');

  if (imageUpload) {
    imageUpload.addEventListener('change', function(e) {
      const files = Array.from(e.target.files);
      
      if (files.length > 0) {
        previewDiv.style.display = 'block';
        previewContainer.innerHTML = '';

        files.forEach((file, index) => {
          // Validate file type
          if (!file.type.match(/^image\/(jpeg|jpg|png|gif|webp)$/)) {
            alert(`"${file.name}" is not a valid image format. Please use JPG, PNG, GIF, or WebP.`);
            return;
          }

          // Validate file size (10MB)
          if (file.size > 10 * 1024 * 1024) {
            alert(`"${file.name}" is too large. Please use images under 10MB.`);
            return;
          }

          const reader = new FileReader();
          reader.onload = function(e) {
            const previewHtml = `
              <div class="column is-one-quarter">
                <div class="card">
                  <div class="card-image">
                    <figure class="image is-square">
                      <img src="${e.target.result}" style="width: 100%; height: 100px; object-fit: cover;">
                    </figure>
                  </div>
                  <div class="card-content">
                    <p class="is-size-7">${file.name}</p>
                    <p class="is-size-7 has-text-grey">${(file.size / 1024 / 1024).toFixed(2)} MB</p>
                  </div>
                </div>
              </div>
            `;
            previewContainer.insertAdjacentHTML('beforeend', previewHtml);
          };
          reader.readAsDataURL(file);
        });
      } else {
        previewDiv.style.display = 'none';
      }
    });
  }
});
</script>





