<%= form_with(
      model: diary_entry,
      local: true,
      multipart: true,
      data: { turbo: false },                 # submit like a normal form
      html: { id: "diary-entry-form" }
    ) do |form| %>

  <% if diary_entry.errors.any? %>
    <div class="notification is-danger">
      <strong><%= pluralize(diary_entry.errors.count, "error") %> prohibited this entry from being saved:</strong>
      <ul>
        <% diary_entry.errors.full_messages.each do |message| %>
          <li><%= message %></li>
        <% end %>
      </ul>
    </div>
  <% end %>

  <!-- ðŸ“ Title Field -->
  <div class="field">
    <%= form.label :title, class: "label" %>
    <div class="control">
      <%= form.text_field :title, class: "input" %>
    </div>
  </div>

  <!-- ðŸ“… Entry Date -->
  <div class="field">
    <%= form.label :entry_date, "Entry date", class: "label" %>
    <div class="control">
      <%= form.date_field :entry_date, class: "input", value: (diary_entry.entry_date || Date.current) %>
    </div>
    <p class="help has-text-info">Select the date for your diary entry</p>
  </div>

  <!-- ðŸ§¾ Content Field -->
  <div class="field">
    <%= form.label :content, class: "label" %>
    <div class="control">
      <%= form.text_area :content,
            rows: 10,
            class: "textarea",
            value: diary_entry.content.respond_to?(:to_plain_text) ? diary_entry.content.to_plain_text : diary_entry.content,
            placeholder: "Write your diary entry here..." %>
    </div>
    <p class="help">Write your diary entry content.</p>
  </div>

  <!-- ðŸ“· Image Upload -->
  <div class="field">
    <%= form.label :images, "Upload Images", class: "label" %>
    <div class="control">
      <%= form.file_field :images, multiple: true, accept: "image/*", class: "input", id: "image-upload" %>
    </div>
    <p class="help">You can select multiple images. Supported formats: JPEG, PNG, GIF, WebP (max 10MB each)</p>
  </div>

  <!-- ðŸ–¼ï¸ Image Preview (JS) -->
  <div id="image-preview" class="field" style="display: none;">
    <label class="label">Uploaded Images</label>
    <div id="image-thumbnails" class="columns is-multiline"></div>
  </div>

  <%# NOTE: Existing Images moved below, outside the form to avoid nested forms and Turbo interference %>

  <!-- ðŸŽ­ Mood Field -->
  <div class="field">
    <%= form.label :mood, class: "label" %>
    <div class="control">
      <%= form.select :mood,
            options_for_select(['happy','sad','excited','calm','motivational','hopeful','reflective','peaceful','joyful'], diary_entry.mood),
            include_blank: true,
            class: "input" %>
    </div>
  </div>

  <!-- ðŸ“Š Status Field -->
  <div class="field">
    <%= form.label :status, class: "label" %>
    <div class="control">
      <%= form.select :status,
            options_for_select(['draft','published'], diary_entry.status),
            class: "input" %>
    </div>
    <p class="help has-text-info">Choose whether to save as draft or publish the entry</p>
  </div>

  <% if @thought_of_the_day %>
    <div class="notification is-info is-light mb-4">
      <strong>Thought of the Day:</strong><br>
      <em><%= @thought_of_the_day.content %></em>
    </div>
  <% end %>

  <div class="field is-grouped mt-4">
    <div class="control">
      <%= form.submit(diary_entry.persisted? ? "Update Entry" : "Create Entry",
            class: "button is-primary",
            data: { disable_with: "Saving..." }) %>
    </div>
    <div class="control">
      <%= link_to "Cancel", diary_entries_path, class: "button is-light" %>
    </div>
  </div>
<% end %>

<%# ðŸ—‚ï¸ Existing Images (outside the form) %>
<% if diary_entry.persisted? && diary_entry.images.attached? %>
  <div class="field mt-5">
    <label class="label">Current Images</label>
    <div class="columns is-multiline">
      <% diary_entry.images.each do |image| %>
        <div class="column is-one-quarter" id="image-<%= image.id %>">
          <div class="card">
            <div class="card-image">
              <figure class="image is-4by3">
                <%= image_tag image, class: "is-rounded", style: "max-width: 200px; max-height: 200px; object-fit: cover;" %>
              </figure>
            </div>
            <div class="card-content">
              <div class="content">
                <p class="is-size-7"><%= image.blob.filename %></p>
                 <%= button_to "Delete",
                       image_diary_entry_path(diary_entry, image_id: image.id),
                       method: :delete,
                       form: { data: { turbo: false } },
                       class: "button is-small is-danger",
                       data: { confirm: "Are you sure you want to delete this image?" } %>
            </div>
          </div>
        </div>
      <% end %>
    </div>
  </div>
<% end %>