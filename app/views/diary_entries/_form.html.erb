<%= form_with(model: @diary_entry, local: true) do |form| %>

  <% if @diary_entry.errors.any? %>
    <div class="notification is-danger">
      <ul>
        <% @diary_entry.errors.full_messages.each do |msg| %>
          <li><%= msg %></li>
        <% end %>
      </ul>
    </div>
  <% end %>

  <div class="field">
    <%= form.label :title, class: "label" %>
    <div class="control">
      <%= form.text_field :title, class: "input" %>
    </div>
  </div>

  <div class="field">
    <%= form.label :entry_date, class: "label" %>
    <div class="control">
      <div class="field has-addons">
        <!-- Hidden date field for form submission -->
        <%= form.date_field :entry_date, class: "input", id: "diary_entry_date_hidden", style: "position: absolute; opacity: 0; pointer-events: none; z-index: -1;", value: (@diary_entry.entry_date || Date.current) %>
        <!-- Visible formatted date input -->
        <div class="control is-expanded">
          <input type="text" 
                 id="diary_entry_date_display" 
                 class="input" 
                 placeholder="ðŸ“… Click to select a date..."
                 readonly
                 style="cursor: pointer; background-color: white;">
        </div>
        <div class="control">
          <button type="button" 
                  class="button is-primary" 
                  onclick="openDatePicker()"
                  style="border-left: none;">
            <span class="icon">
              <i class="fas fa-calendar-alt"></i>
            </span>
          </button>
        </div>
      </div>
    </div>
    <p class="help has-text-info">Click to select a date - it will show as "Tuesday, 3 April 2025"</p>
  </div>

  <div class="field">
    <%= form.label :content, "Diary Entry Content", class: "label" %>
    <div class="control">
      <%= form.rich_text_area :content, class: "rich-text-area", data: { behavior: "content-placeholder" } %>
    </div>
    <p class="help">Write your diary entry here...</p>
  </div>



  <div class="field">
    <div class="control">
      <%= form.submit class: "button is-primary" %>
    </div>
  </div>
<% end %>

<script>
function openDatePicker() {
  const dateInputHidden = document.getElementById('diary_entry_date_hidden');
  if (dateInputHidden) {
    if (dateInputHidden.showPicker) {
      dateInputHidden.showPicker();
    } else {
      // Fallback for browsers that don't support showPicker
      dateInputHidden.focus();
      dateInputHidden.click();
    }
  }
}

document.addEventListener('DOMContentLoaded', function() {
  const dateInputHidden = document.getElementById('diary_entry_date_hidden');
  const dateInputDisplay = document.getElementById('diary_entry_date_display');
  
  if (!dateInputHidden || !dateInputDisplay) {
    console.error('Date picker elements not found');
    return;
  }
  
  function updateDateDisplay() {
    try {
      if (dateInputHidden.value) {
        const selectedDate = new Date(dateInputHidden.value + 'T00:00:00');
        if (!isNaN(selectedDate.getTime())) {
          // Format as "Tuesday, 3 April 2025"
          const options = { 
            weekday: 'long', 
            year: 'numeric', 
            month: 'long', 
            day: 'numeric' 
          };
          const formattedDate = selectedDate.toLocaleDateString('en-GB', options);
          dateInputDisplay.value = `ðŸ“… ${formattedDate}`;
          dateInputDisplay.style.color = '#3273dc';
          dateInputDisplay.style.fontWeight = '600';
        } else {
          dateInputDisplay.value = '';
          dateInputDisplay.style.color = '';
          dateInputDisplay.style.fontWeight = '';
        }
      } else {
        dateInputDisplay.value = '';
        dateInputDisplay.style.color = '';
        dateInputDisplay.style.fontWeight = '';
      }
    } catch (error) {
      console.error('Error updating date display:', error);
      dateInputDisplay.value = dateInputHidden.value || '';
    }
  }
  
  // Update display when hidden date input changes
  dateInputHidden.addEventListener('change', function() {
    console.log('Date changed to:', dateInputHidden.value);
    updateDateDisplay();
  });
  
  // Also listen for input events (more reliable on some browsers)
  dateInputHidden.addEventListener('input', function() {
    console.log('Date input to:', dateInputHidden.value);
    updateDateDisplay();
  });
  
  // Handle clicking on display input to open date picker
  dateInputDisplay.addEventListener('click', openDatePicker);
  
  // Update display on page load if date is already set
  updateDateDisplay();
  
  // Force update after a short delay to ensure everything is loaded
  setTimeout(updateDateDisplay, 100);
});
</script>





