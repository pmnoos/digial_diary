<p style="color: green"><%= notice %></p>

<% content_for :title, "Diary entries" %>

<% unless user_signed_in? %>
  <div class="notification is-info is-light mb-4 demo-visit-banner">
    <div class="content has-text-centered">
      <p class="has-text-weight-semibold">üìî You're viewing demo content</p>
      <p>This is a sample diary with real entries to showcase the Digital Diary experience. 
         <%= link_to "Sign up for free", new_user_registration_path, class: "has-text-link has-text-weight-semibold" %> 
         to start your own digital diary!</p>
      <button class="button is-primary is-small mt-2" onclick="showDemoTour()">
        <span class="icon">
          <i class="fas fa-map-marked-alt"></i>
        </span>
        <span>Take Demo Tour</span>
      </button>
    </div>
  </div>
  
  <!-- Include Demo Tour Modal -->
  <%= render 'shared/demo_tour' %>
  
  <!-- Tag Suggestions for Demo Visitors -->
  <div class="notification is-success is-light mb-4">
    <div class="content">
      <h5 class="title is-5">üè∑Ô∏è Explore by Popular Tags</h5>
      <p>Try searching for these topics to discover interesting entries:</p>
      <div class="tags mt-2">
        <% popular_tags = ['travel', 'work-life', 'family-time', 'creativity', 'fitness', 'cooking', 'reading', 'meditation', 'friends', 'celebrations'] %>
        <% popular_tags.each do |tag| %>
          <%= link_to diary_entries_path(search: tag), class: "tag is-success is-medium" do %>
            <span><%= tag.titleize %></span>
          <% end %>
        <% end %>
      </div>
      <p class="help">Click any tag to search for related entries!</p>
    </div>
  </div>
<% end %>

<div class="container">
  <h1 class="title is-3">Diary entries</h1>

  <!-- Search and Filter Section -->
  <div class="box mb-4">
    <%= form_with url: diary_entries_path, method: :get, local: true, class: "field is-grouped" do |form| %>
      <div class="control is-expanded">
        <%= form.text_field :search, value: params[:search], 
            placeholder: "Search your diary entries...", 
            class: "input" %>
      </div>
      <div class="control">
        <%= form.select :year, options_from_collection_for_select(@available_years, :to_s, :to_s, params[:year]), 
            { prompt: "All years" }, 
            { class: "select" } %>
      </div>
      <div class="control">
        <%= form.submit "Filter", class: "button is-primary" %>
      </div>
      <% if params[:search].present? || params[:year].present? %>
        <div class="control">
          <%= link_to "Clear", diary_entries_path, class: "button is-light" %>
        </div>
      <% end %>
    <% end %>
    
    <% if params[:search].present? %>
      <p class="has-text-grey mt-2">
        <em>Searching for: "<%= params[:search] %>"</em>
      </p>
    <% end %>
    
    <% if params[:year].present? %>
      <p class="has-text-grey mt-2">
        <em>Showing entries from: <%= params[:year] %></em>
      </p>
    <% end %>
  </div>

  <!-- Diary Entries Grid -->
  <div class="columns is-multiline">
    <% @diary_entries.each do |diary_entry| %>
      <div class="column is-one-third">
        <div class="box" style="min-height: 320px; display: flex; flex-direction: column;">
          <div style="flex-grow: 1;">
            <h2 class="title is-5">
              <%= link_to diary_entry.title, diary_entry_path(diary_entry) %>
            </h2>
            <p class="has-text-info has-text-weight-semibold mb-3">
              <em><%= diary_entry.entry_date.strftime("%A, %d %B %Y") %></em>
            </p>
            
              <div class="content mb-3">
              <% content_limit = 80 %>
              <% if diary_entry.content.present? && diary_entry.content.length > content_limit %>
                <div id="content-short-<%= diary_entry.id %>">
                  <%= truncate(diary_entry.content, length: content_limit) %>
                  <a href="#" class="has-text-primary" onclick="showFullContent(<%= diary_entry.id %>); return false;"> Read more</a>
                </div>
                <div id="content-full-<%= diary_entry.id %>" style="display: none; max-height: 200px; overflow-y: auto;">
                  <div style="white-space: pre-wrap;"><%= diary_entry.content %></div>
                  <a href="#" class="has-text-primary" onclick="showShortContent(<%= diary_entry.id %>); return false;"> Show less</a>
                </div>
              <% elsif diary_entry.content.present? %>
                <div style="white-space: pre-wrap;"><%= diary_entry.content %></div>
              <% else %>
                <p class="has-text-grey"><em>No content available</em></p>
              <% end %>
            </div>

            
            <% if diary_entry.images.attached? %>
              <div class="mt-2 mb-3">
                <div class="is-flex is-align-items-center mb-2">
                  <span class="icon-text has-text-primary">
                    <span class="icon">
                      <i class="fas fa-images"></i>
                    </span>
                    <span class="is-size-7 has-text-weight-semibold">Photo Gallery (<%= diary_entry.images.count %> <%= 'photo'.pluralize(diary_entry.images.count) %>)</span>
                  </span>
                </div>
                <% diary_entry.images.first(3).each do |image| %>
                  <% begin %>
                    <%= image_tag image, class: "image is-inline-block mr-1", style: "width: 50px; height: 50px; object-fit: cover; border-radius: 4px; border: 2px solid #dbdbdb;", loading: "lazy" %>
                  <% rescue => e %>
                    <div class="image is-inline-block mr-1" style="width: 50px; height: 50px; background: #ffebee; border-radius: 4px; border: 2px solid #dbdbdb; display: flex; align-items: center; justify-content: center;">
                      <i class="fas fa-exclamation-triangle has-text-danger" style="font-size: 12px;"></i>
                    </div>
                  <% end %>
                <% end %>
                <% if diary_entry.images.count > 3 %>
                  <span class="tag is-light is-small">+<%= diary_entry.images.count - 3 %> more</span>
                <% end %>
              </div>
            <% end %>
          </div>
          
          <!-- Buttons always at bottom -->
          <div style="margin-top: auto;">
            <%= link_to "Read entry", diary_entry, class: "button is-link is-small" %>
            <% if user_signed_in? %>
              <%= link_to "Edit", edit_diary_entry_path(diary_entry), class: "button is-primary is-small ml-1" %>
              <%= link_to "Delete", diary_entry_path(diary_entry), 
                  class: "button is-danger is-small ml-1",
                  data: { 
                    turbo_method: :delete,
                    turbo_confirm: "Are you sure you want to delete this diary entry?" 
                  } %>
            <% end %>
          </div>
        </div>
      </div>
    <% end %>
  </div>

  <div class="mt-4">
    <% if user_signed_in? %>
      <%= link_to "New diary entry", new_diary_entry_path, class: "button is-primary" %>
    <% else %>
      <div class="notification is-info is-light">
        <p class="has-text-centered">
          <strong>Want to create your own diary entries?</strong><br>
          <%= link_to "Sign up now", new_user_registration_path, class: "button is-primary" %> 
          to start your personal diary journey!
        </p>
      </div>
    <% end %>
  </div>

  <!-- Statistics Section -->
  <div class="box mt-4">
    <% if user_signed_in? %>
      <h3 class="title is-5">üìä Your Diary Statistics</h3>
    <% else %>
      <h3 class="title is-5">üìä Demo Diary Statistics</h3>
      <p class="subtitle is-6 has-text-grey">See what your stats could look like!</p>
    <% end %>
    <div class="columns">
      <div class="column">
        <div class="has-text-centered">
          <p class="title is-4 has-text-primary"><%= @diary_entries.total_count %></p>
          <p class="subtitle is-6">Total Entries</p>
          <% unless user_signed_in? %>
            <span class="tag is-info is-light">Demo shows <%= @diary_entries.total_count %> entries!</span>
          <% end %>
        </div>
      </div>
      <div class="column">
        <div class="has-text-centered">
          <p class="title is-4 has-text-info"><%= @available_years.count %></p>
          <p class="subtitle is-6">Years of Memories</p>
          <% unless user_signed_in? %>
            <span class="tag is-info is-light">Spanning <%= @available_years.count %> years</span>
          <% end %>
        </div>
      </div>
      <div class="column">
        <div class="has-text-centered">
          <p class="title is-4 has-text-success">
            <% if user_signed_in? %>
              <%= current_user.diary_entries.joins(:images_attachments).distinct.count %>
            <% else %>
              <%= DiaryEntry.joins(:user, :images_attachments).where(users: { username: 'DemoUser' }).distinct.count %>
            <% end %>
          </p>
          <p class="subtitle is-6">Entries with Photos</p>
          <% unless user_signed_in? %>
            <span class="tag is-success is-light">Visual memories!</span>
          <% end %>
        </div>
      </div>
    </div>
    
    <% unless user_signed_in? %>
      <div class="has-text-centered mt-4">
        <p class="has-text-grey">
          <em>Imagine your own diary growing this rich with memories...</em>
        </p>
        <%= link_to new_user_registration_path, class: "button is-primary mt-2" do %>
          <span class="icon">
            <i class="fas fa-rocket"></i>
          </span>
          <span>Start Your Journey Today</span>
        <% end %>
      </div>
    <% end %>
  </div>

  <div class="pagination mt-4">
    <%= paginate @diary_entries %>
  </div>
</div>


<script>
// Simple read more/less functionality for diary entries
function showFullContent(entryId) {
  console.log('showFullContent called with ID:', entryId);
  var shortElement = document.getElementById('content-short-' + entryId);
  var fullElement = document.getElementById('content-full-' + entryId);
  
  if (shortElement && fullElement) {
    shortElement.style.display = 'none';
    fullElement.style.display = 'block';
    console.log('Successfully toggled to full content');
  }
}

function showShortContent(entryId) {
  console.log('showShortContent called with ID:', entryId);
  var shortElement = document.getElementById('content-short-' + entryId);
  var fullElement = document.getElementById('content-full-' + entryId);
  
  if (shortElement && fullElement) {
    shortElement.style.display = 'block';
    fullElement.style.display = 'none';
    console.log('Successfully toggled to short content');
  }
}
</script>