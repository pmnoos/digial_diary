<p style="color: green"><%= notice %></p>

<% content_for :title, "Diary entries" %>

<h1 class="title is-3">Diary entries</h1>

<!-- Search and Filter Section -->
<div class="box mb-4">
  <%= form_with url: diary_entries_path, method: :get, local: true, class: "field is-grouped" do |form| %>
    <div class="control is-expanded">
      <%= form.text_field :search, value: params[:search], 
          placeholder: "Search your diary entries...", 
          class: "input" %>
    </div>
    <div class="control">
      <%= form.select :year, options_from_collection_for_select(@available_years, :to_s, :to_s, params[:year]), 
          { prompt: "All years" }, 
          { class: "select" } %>
    </div>
    <div class="control">
      <%= form.submit "Filter", class: "button is-primary" %>
    </div>
    <% if params[:search].present? || params[:year].present? %>
      <div class="control">
        <%= link_to "Clear", diary_entries_path, class: "button is-light" %>
      </div>
    <% end %>
  <% end %>
  
  <% if params[:search].present? %>
    <p class="has-text-grey mt-2">
      <em>Searching for: "<%= params[:search] %>"</em>
    </p>
  <% end %>
  
  <% if params[:year].present? %>
    <p class="has-text-grey mt-2">
      <em>Showing entries from: <%= params[:year] %></em>
    </p>
  <% end %>
</div>

<div class="columns is-multiline">
  <% @diary_entries.each do |diary_entry| %>
    <div class="column is-one-third">
      <div class="box">
        <h2 class="title is-5">
          <%= link_to diary_entry.title, diary_entry_path(diary_entry) %>
        </h2>
        <p><em><%= diary_entry.entry_date.strftime("%A, %-d %B %Y") %></em></p>
        <p><%= truncate(diary_entry.content.body.to_plain_text, length: 100) %></p>
        
        <% if diary_entry.images.attached? %>
          <div class="mt-2 mb-2">
            <% diary_entry.images.first(3).each do |image| %>
              <%= image_tag rails_blob_path(image), class: "image is-inline-block mr-1", style: "width: 40px; height: 40px; object-fit: cover; border-radius: 4px;" %>
            <% end %>
            <% if diary_entry.images.count > 3 %>
              <span class="tag is-light">+<%= diary_entry.images.count - 3 %> more</span>
            <% end %>
          </div>
        <% end %>
        
        <p>
          <%= link_to "Read entry", diary_entry, class: "button is-link is-small mt-2" %>
        </p>
      </div>
    </div>
  <% end %>
</div>

<div class="mt-4">
  <%= link_to "New diary entry", new_diary_entry_path, class: "button is-primary" %>
</div>

<!-- Statistics Section -->
<div class="box mt-4">
  <h3 class="title is-5">ðŸ“Š Your Diary Statistics</h3>
  <div class="columns">
    <div class="column">
      <div class="has-text-centered">
        <p class="title is-4 has-text-primary"><%= @diary_entries.total_count %></p>
        <p class="subtitle is-6">Total Entries</p>
      </div>
    </div>
    <div class="column">
      <div class="has-text-centered">
        <p class="title is-4 has-text-info"><%= @available_years.count %></p>
        <p class="subtitle is-6">Years of Memories</p>
      </div>
    </div>
    <div class="column">
      <div class="has-text-centered">
        <p class="title is-4 has-text-success">
          <%= current_user.diary_entries.joins(:images_attachments).distinct.count %>
        </p>
        <p class="subtitle is-6">Entries with Photos</p>
      </div>
    </div>
  </div>
</div>

<div class="pagination mt-4">
  <%= paginate @diary_entries %>
</div>

