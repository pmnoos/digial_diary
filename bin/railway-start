#!/bin/bash

# Railway deployment script for Rails app
echo "ğŸš‚ Starting Railway deployment..."

# Set environment variables for Rails
export RAILS_ENV=production
export RAILS_SERVE_STATIC_FILES=true
export RAILS_LOG_TO_STDOUT=true

# Check if we have all required environment variables
if [ -z "$RAILS_MASTER_KEY" ]; then
  echo "âŒ RAILS_MASTER_KEY is not set!"
  exit 1
fi

if [ -z "$DATABASE_URL" ] && [ -z "$PGHOST" ]; then
  echo "âŒ No database configuration found!"
  exit 1
fi

echo "âœ… Environment variables check passed"

# Run database migrations
echo "ğŸ—„ï¸ Running database migrations..."
bundle exec rails db:migrate || {
  echo "âŒ Database migration failed!"
  exit 1
}

echo "âœ… Database migrations completed"

# Check if the app can boot
echo "ğŸ” Testing app boot..."
bundle exec rails runner "puts 'âœ… Rails app boots successfully'" || {
  echo "âŒ Rails app failed to boot!"
  exit 1
}

# Start the Rails server
echo "ğŸš€ Starting Rails server on port $PORT..."
bundle exec rails server -b 0.0.0.0 -p $PORT
